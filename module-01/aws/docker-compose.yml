# LocalStack Docker Compose Configuration
# This file starts LocalStack with configurable settings via .env file
#
# Quick Start:
#   1. Copy .env.example to .env: cp .env.example .env
#   2. Adjust settings in .env as needed
#   3. Start LocalStack: docker compose up -d
#   4. View logs: docker compose logs -f localstack
#   5. Stop LocalStack: docker compose down
#
# AWS CLI Configuration (Required):
#   Configure AWS CLI with test credentials for LocalStack:
#   - Option 1 (Environment variables):
#       export AWS_ACCESS_KEY_ID=test
#       export AWS_SECRET_ACCESS_KEY=test
#       export AWS_REGION=us-east-1
#       aws --endpoint-url=http://localhost:4566 s3 ls
#
#   - Option 2 (AWS profile - recommended):
#       aws configure set aws_access_key_id test --profile localstack
#       aws configure set aws_secret_access_key test --profile localstack
#       aws configure set region us-east-1 --profile localstack
#       aws --profile localstack --endpoint-url=http://localhost:4566 s3 ls
#
#   Note: For S3 pre-signed URLs to work, credentials must be set to "test"

# Define Docker volumes for data persistence
volumes:
  localstack-data:
    driver: local
    name: localstack-data

services:
  localstack:
    container_name: ${LOCALSTACK_CONTAINER_NAME:-localstack-main}
    image: ${LOCALSTACK_IMAGE:-localstack/localstack:4.12.0}
    ports:
      # LocalStack Gateway (Edge Port)
      - "127.0.0.1:4566:4566"
      # External services port range
      - "127.0.0.1:4510-4559:4510-4559"
    environment:
      # === Core Configuration ===
      # Enable/disable debug mode (0 or 1)
      - DEBUG=${DEBUG:-0}

      # === Services Configuration ===
      # In LocalStack 4.x, services are loaded on-demand by default
      # No need to specify SERVICES variable - deprecated in 4.x

      # === Persistence ===
      # Enable persistence (0 or 1) - state is stored in Docker volume
      - PERSISTENCE=${PERSISTENCE:-1}

      # === Network Configuration ===
      # DNS address for LocalStack (0 for default)
      - DNS_ADDRESS=${DNS_ADDRESS:-0}

      # === LocalStack Pro (Optional) ===
      # Uncomment and add your auth token to enable Pro features
      # - LOCALSTACK_AUTH_TOKEN=${LOCALSTACK_AUTH_TOKEN}

    volumes:
      # Persist LocalStack data in a Docker volume
      # IMPORTANT: Mount to /var/lib/localstack (not /data) for persistence to work
      # State is stored in /var/lib/localstack/state subdirectory
      - localstack-data:/var/lib/localstack
      # Mount Docker socket for Docker-in-Docker (required for Lambda and ECS)
      - /var/run/docker.sock:/var/run/docker.sock

    # Resource limits (adjust based on your system)
    deploy:
      resources:
        limits:
          cpus: 2.0
          memory: 2g
        reservations:
          cpus: 0.5
          memory: 512m

    # Restart policy
    restart: unless-stopped

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

# Optional: Add a custom init container that waits for LocalStack to be ready
# This is useful for scripts that need to interact with LocalStack immediately
# init:
#   image: alpine:latest
#   depends_on:
#     localstack:
#       condition: service_healthy
#   command: >
#     sh -c "
#       echo 'LocalStack is ready!' &&
#       echo 'Edge endpoint: http://localhost:4566' &&
#       echo 'Health check: curl http://localhost:4566/_localstack/health'
#     "
#   restart: "no"
